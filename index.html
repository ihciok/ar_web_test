<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>TEST-AR</title>

    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.2/aframe/build/aframe-ar.js"></script>

    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
</head>

<body style="margin : 0px; overflow: hidden;">
    <a-scene embedded arjs="debugUIEnabled:false;">
        <a-entity camera></a-entity>

        <!-- Markerを表示した際の処理を以下に記述する -->
        <!-- ARマーカーのファイル名をここで指定する -->
        <a-marker type="pattern" url="img/pattern_simple_qrcode.patt">

            <!-- 表示したい画像を src= ～ で指定する -->
            <!-- 画像の大きさは width と height で設定可能 -->
            <!-- 画像を表示させる位置は position で設定可能 -->
            <!-- 画像を水平に表示させる場合は下記の rotation でOK -->
            <!-- <a-image width="5" height="5" position="0.2 0.4 0.4" rotation="-90 0 0" src="img/icon.png">
            </a-image> -->

            <!-- PDF表示用のエンティティ -->
            <a-entity id="pdf-viewer" position="0 1.6 -2"></a-entity>
            <a-entity id="pdf-viewer" pdf-viewer="url: https://github.com/ihciok/ar_web_test/blob/main/img/sample.pdf" position="0 1.6 -2"></a-entity>

            <!-- ページ遷移用ボタン -->
            <a-entity id="prev-page" position="-1 1.6 -1" geometry="primitive: plane; width: 0.5; height: 0.2" material="color: blue" pdf-button="action: prev"></a-entity>
            <a-entity id="next-page" position="1 1.6 -1" geometry="primitive: plane; width: 0.5; height: 0.2" material="color: red" pdf-button="action: next"></a-entity>

        </a-marker>
    </a-scene>

    <!-- PDF表示とページ遷移のためのスクリプト -->
    <script>
        // ここにJavaScriptコードを追加
        AFRAME.registerComponent('pdf-viewer', {
            schema: {
                url: {type: 'string'}
            },
            init: function () {
                const el = this.el;
                const data = this.data;
                let pdfDoc = null;
                let pageNum = 1;

                pdfjsLib.getDocument(data.url).promise.then(function(pdfDoc_) {
                    pdfDoc = pdfDoc_;
                    renderPage(pageNum);
                });

                function renderPage(num) {
                    pdfDoc.getPage(num).then(function(page) {
                        var viewport = page.getViewport({scale: 2.0});
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        var renderContext = {
                            canvasContext: ctx,
                            viewport: viewport
                        };
                        page.render(renderContext).promise.then(function () {
                            const texture = new THREE.Texture(canvas);
                            texture.needsUpdate = true;
                            el.setObject3D('mesh', new THREE.Mesh(
                                new THREE.PlaneGeometry(viewport.width / 200, viewport.height / 200),
                                new THREE.MeshBasicMaterial({map: texture})
                            ));
                        });
                    });
                }

                // ページ遷移のためのイベントリスナー
                document.getElementById('next-page').addEventListener('click', function () {
                    if (pageNum >= pdfDoc.numPages) return;
                    pageNum++;
                    renderPage(pageNum);
                });

                document.getElementById('prev-page').addEventListener('click', function () {
                    if (pageNum <= 1) return;
                    pageNum--;
                    renderPage(pageNum);
                });
            }
        });

        // ページ遷移用ボタンのコンポーネントを追加（必要に応じて）

    </script>

</body>

</html>
